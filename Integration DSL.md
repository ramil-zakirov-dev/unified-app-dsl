# Integration DSL — Документация

**Integration DSL** — это слой в архитектуре Unified App DSL, отвечающий за декларативное описание и использование внешних сервисов: отправка e-mail, SMS, авторизация, платёжные шлюзы, пуш-уведомления и многое другое.

## Цели DSL

* Централизованное описание сторонних API и сервисов
* Переиспользуемость и независимость от конкретных реализаций
* Интеграция в Behavior / Logic DSL, UI DSL, Test DSL
* Простота тестирования и мокирования интеграций

---

## Основные конструкции

### Описание интеграции

```dsl
интеграция SendGrid {
  тип: email
  ключ: "SENDGRID_API_KEY"
  шаблоны: {
    welcome: "template_id_123",
    reset: "template_id_456"
  }
}

интеграция Twilio {
  тип: sms
  аккаунтSid: "ACxxx"
  токен: "xxx"
  отправитель: "+1234567890"
}
```

### Использование в действиях

```dsl
действие отправитьСмс {
  использовать: Twilio
  параметры: {
    телефон: пользователь.телефон
    текст: "Ваш код: {код}"
  }
}

действие отправитьПисьмо {
  использовать: SendGrid
  шаблон: welcome
  получатель: пользователь.email
  данные: {
    имя: пользователь.имя
  }
}
```

---

## Поддерживаемые типы интеграций

| Тип         | Назначение                       | Примеры             |
| ----------- | -------------------------------- | ------------------- |
| `email`     | Отправка писем                   | SendGrid, Mailgun   |
| `sms`       | Отправка СМС                     | Twilio, SMS.ru      |
| `push`      | Push-уведомления                 | OneSignal, Firebase |
| `auth`      | Аутентификация и OAuth           | Firebase, Auth0     |
| `payment`   | Платёжные шлюзы                  | Stripe, YooKassa    |
| `analytics` | Сбор пользовательской аналитики  | Amplitude, Mixpanel |
| `webhook`   | Приём и отправка внешних событий | Custom URLs         |
| `storage`   | Загрузка и хранение файлов       | AWS S3, Supabase    |

---

## Продвинутые примеры

### Интеграция с платёжной системой

```dsl
интеграция Stripe {
  тип: payment
  ключ: "STRIPE_SECRET_KEY"
  валюта: "usd"
}

действие создатьСессиюОплаты {
  использовать: Stripe
  параметры: {
    сумма: 1999
    описание: "Подписка на 1 месяц"
    успехURL: "/успех"
    ошибкаURL: "/ошибка"
  }
  вернуть: ссылкаОплаты
}
```

### Push-уведомление

```dsl
интеграция FirebasePush {
  тип: push
  ключ: "FIREBASE_KEY"
}

действие отправитьУведомление {
  использовать: FirebasePush
  параметры: {
    устройство: пользователь.устройствоId
    заголовок: "Новая заявка!"
    тело: "Проверьте панель управления"
  }
}
```

---

## Интеграция с другими DSL

| DSL                  | Роль интеграции                           |
| -------------------- | ----------------------------------------- |
| Behavior / Logic DSL | Использует интеграции в действиях         |
| UI DSL               | Кнопки, формы инициируют вызовы           |
| Test DSL             | Возможность подмены/мока внешних сервисов |
| Validation DSL       | Проверка данных перед отправкой           |

---

## Тестирование

```dsl
тест "Отправка письма при регистрации" {
  когда: регистрацияПользователя(имя: "Анна", email: "anna@example.com")
  тогда: письмоОтправлено(на: "anna@example.com", шаблон: welcome)
}
```

---

## Возможные расширения

* Условные вызовы интеграций (if/else)
* Группы интеграций и fallback-механизмы
* Rate limit и ретраи
* Безопасное хранение ключей и переменных среды

---
